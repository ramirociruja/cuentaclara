workflows:
Â  ios_prepare:
Â  Â  name: iOS Prepare (no signing)
Â  Â  working_directory: frontend
Â  Â  max_build_duration: 60
Â  Â  environment:
Â  Â  Â  flutter: stable
Â  Â  Â  xcode: latest
Â  Â  Â  cocoapods: default
Â  Â  Â  vars:
Â  Â  Â  Â  BUNDLE_ID: com.cuentaclara.app
Â  Â  Â  Â  BUILD_NAME: 1.0.0
Â  Â  Â  Â  BUILD_NUMBER: 1
Â  Â  Â  Â  API_BASE_URL: https://cuentaclara-production.up.railway.app
Â  Â  cache:
Â  Â  Â  cache_paths:
        - ~/.pub-cache
        - ~/Library/Caches/CocoaPods
        - ios/Pods
        - build
Â  Â  scripts:
Â  Â  Â  - name: Flutter clean & pub get
Â  Â  Â  Â  script: |
          flutter clean
          flutter pub get
Â  Â  Â  - name: Install pods (iOS)
Â  Â  Â  Â  script: |
          cd ios
          pod install --repo-update
          cd ..
Â  Â  Â  - name: Build iOS (no code signing)
Â  Â  Â  Â  script: |
          flutter build ios --release --no-codesign \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --dart-define=API_BASE_URL=$API_BASE_URL
Â  Â  artifacts:
      - build/ios/iphoneos/*.app

Â  ios_testflight:
Â  Â  name: iOS Release â†’ TestFlight (signed)
Â  Â  working_directory: frontend
Â  Â  max_build_duration: 90
Â  Â  environment:
Â  Â  Â  flutter: stable
Â  Â  Â  xcode: latest
Â  Â  Â  cocoapods: default
Â  Â  Â  groups:
        - app_store_connect # Â¡Mantener! Conecta las variables con el workflow.
Â  Â  Â  vars:
Â  Â  Â  Â  BUNDLE_ID: com.cuentaclara.app
Â  Â  Â  Â  BUILD_NAME: 1.0.0
Â  Â  Â  Â  BUILD_NUMBER: 1
Â  Â  Â  Â  API_BASE_URL: https://cuentaclara-production.up.railway.app
Â  Â  Â  Â  TEAM_ID: XQJ843FZ7Q # Se necesita para la firma automÃ¡tica.
Â  Â  cache:
Â  Â  Â  cache_paths:
        - ~/.pub-cache
        - ~/Library/Caches/CocoaPods
        - ios/Pods
        - build

Â  Â  scripts:
Â  Â  Â  - name: Flutter clean & pub get
Â  Â  Â  Â  script: |
          flutter clean
          flutter pub get

Â  Â  Â  - name: Install pods
Â  Â  Â  Â  script: |
          cd ios
          pod install --repo-update
          cd ..

Â  Â  Â  - name: Code Signing (AUTOMATIC) ðŸš€
Â  Â  Â  Â  # Codemagic usa la API Key para crear/descargar el certificado (.p12)
Â  Â  Â  Â  # y el perfil de aprovisionamiento (.mobileprovision) automÃ¡ticamente.
Â  Â  Â  Â  script: |
          xcode-project use-profiles \
            --project "ios/Runner.xcodeproj" \
            --profile "CM_PROVISIONING_PROFILE_APP_STORE" \
            --certificate "CM_CERTIFICATE_APP_STORE" \
            --project-type flutter

Â  Â  Â  - name: Build & Sign IPA (SIMPLE)
Â  Â  Â  Â  # Se usa 'flutter build ipa' que usa los perfiles configurados en el paso anterior.
Â  Â  Â  Â  script: |
          flutter build ipa --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --dart-define=API_BASE_URL=$API_BASE_URL

Â  Â  Â  - name: Imprimir info IPA (opcional)
Â  Â  Â  Â  script: |
          xcode-project ipa-info build/ios/ipa/*.ipa || true

Â  Â  artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive

Â  Â  publishing:
Â  Â  Â  app_store_connect:
Â  Â  Â  Â  api_key: $APP_STORE_CONNECT_PRIVATE_KEY
Â  Â  Â  Â  key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
Â  Â  Â  Â  issuer_id: $APP_STORE_CONNECT_ISSUER_ID
Â  Â  Â  Â  submit_to_testflight: true
Â  Â  Â  Â  # beta_groups:
Â  Â  Â  Â  # Â  - Internal Testers